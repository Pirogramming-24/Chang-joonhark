{% extends 'base.html' %}

{% block content %}
<div class="container mt-4" style="max-width: 600px;">

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="card mb-4">
            <div class="card-header bg-warning text-dark fw-bold">ìƒí’ˆ ì •ë³´</div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="title" class="form-label">ì œëª©</label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>

                <div class="mb-3">
                    <label for="content" class="form-label">ë‚´ìš©</label>
                    <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
                </div>

                <div class="mb-3">
                    <label for="region" class="form-label">ì§€ì—­</label>
                    <input type="text" class="form-control" id="region" name="region" required>
                </div>

                <div class="mb-3">
                    <label for="price" class="form-label">ê°€ê²© (ì›)</label>
                    <input type="number" class="form-control" id="price" name="price" value="1000">
                </div>

                <div class="mb-3">
                    <label for="id_user" class="form-label">ì‘ì„±ì</label>
                    {{ form.user }}
                </div>

                <div class="mb-3">
                    <label for="photo" class="form-label">ìƒí’ˆ ì´ë¯¸ì§€</label>
                    <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
                </div>
            </div>
        </div>

        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white fw-bold">ì‹í’ˆ ì˜ì–‘ ì •ë³´ (OCR ë¶„ì„)</div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="ocr-input" class="form-label fw-bold">ğŸ“¸ ì˜ì–‘ì„±ë¶„í‘œ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</label>
                    <input type="file" class="form-control" id="ocr-input" name="nutrition_image" accept="image/*">
                    
                    <div id="ocr-loading" class="mt-2 text-primary" style="display:none;">
                        <span class="spinner-border spinner-border-sm"></span> AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                    </div>
                </div>

                <hr>

                <div class="mb-3">
                    <label class="form-label">ì¹¼ë¡œë¦¬ ì •ë³´ (Kcal)</label>
                    <input type="number" step="0.1" class="form-control" name="calories" id="calories" placeholder="0">
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">íƒ„ìˆ˜í™”ë¬¼ (g)</label>
                        <input type="number" step="0.1" class="form-control" name="carbohydrate" id="carbohydrate" placeholder="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">ë‹¨ë°±ì§ˆ (g)</label>
                        <input type="number" step="0.1" class="form-control" name="protein" id="protein" placeholder="0">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">ì§€ë°© (g)</label>
                        <input type="number" step="0.1" class="form-control" name="fat" id="fat" placeholder="0">
                    </div>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success btn-lg">ë“±ë¡í•˜ê¸°</button>
        </div>
    </form>
</div>

<script>
    document.getElementById('ocr-input').addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;

        // 1. ë¡œë”© í‘œì‹œ ë° ì…ë ¥ì°½ ì ê¸ˆ
        const loadingDiv = document.getElementById('ocr-loading');
        const inputs = {
            cal: document.getElementById('calories'),
            carb: document.getElementById('carbohydrate'),
            prot: document.getElementById('protein'),
            fat: document.getElementById('fat')
        };

        loadingDiv.style.display = 'block';
        for (let key in inputs) {
            inputs[key].value = '';
            inputs[key].placeholder = 'ë¶„ì„ ì¤‘...';
            inputs[key].readOnly = true;
        }

        // 2. ì„œë²„ë¡œ ì „ì†¡í•  ë°ì´í„° ì¤€ë¹„
        const formData = new FormData();
        
        // â˜…â˜…â˜… [ìˆ˜ì • í•µì‹¬] views.pyê°€ 'image'ë¼ëŠ” ì´ë¦„ì„ ì°¾ìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ë§ì¶°ì•¼ í•©ë‹ˆë‹¤! â˜…â˜…â˜…
        formData.append('image', file); 

        try {
            const response = await fetch("{% url 'posts:analyze_image' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });

            const result = await response.json();

            if (!response.ok) {
                // ì„œë²„ê°€ 400ì´ë‚˜ 500 ì—ëŸ¬ë¥¼ ë³´ëƒˆì„ ë•Œ
                throw new Error(result.error || 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
            }

            // 3. ê²°ê³¼ ìë™ ì…ë ¥
            // views.pyëŠ” { calories: 0, carbohydrate: 0 ... } í˜•íƒœë¡œ ë°”ë¡œ ì¤ë‹ˆë‹¤.
            // result.successë‚˜ result.data ì•ˆì— ë“¤ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.
            
            if (result.error) {
                alert("ë¶„ì„ ì‹¤íŒ¨: " + result.error);
            } else {
                inputs.cal.value = result.calories || 0;
                inputs.carb.value = result.carbohydrate || 0;
                inputs.prot.value = result.protein || 0;
                inputs.fat.value = result.fat || 0;
            }

        } catch (error) {
            console.error('Error:', error);
            alert("ì´ë¯¸ì§€ ë¶„ì„ ì‹¤íŒ¨: " + error.message);
        } finally {
            // 4. ì…ë ¥ì°½ ì ê¸ˆ í•´ì œ
            loadingDiv.style.display = 'none';
            for (let key in inputs) {
                inputs[key].readOnly = false;
                if (!inputs[key].value) inputs[key].placeholder = '0';
            }
        }
    });
</script>
{% endblock %}