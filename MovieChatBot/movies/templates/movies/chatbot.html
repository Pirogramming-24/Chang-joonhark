{% extends 'movies/base.html' %}

{% block content %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 20px auto;
        height: 600px;
        background-color: #111;
        border: 1px solid #333;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-header {
        background-color: var(--neon-green);
        color: black;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        font-size: 1.2rem;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        max-width: 80%;
        padding: 12px 18px;
        border-radius: 15px;
        line-height: 1.5;
        font-size: 0.95rem;
    }

    /* AI ë©”ì‹œì§€ (ì™¼ìª½) */
    .message.bot {
        align-self: flex-start;
        background-color: #222;
        color: #ddd;
        border: 1px solid #444;
        border-bottom-left-radius: 2px;
    }

    /* ì‚¬ìš©ì ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½) */
    .message.user {
        align-self: flex-end;
        background-color: var(--neon-green);
        color: black;
        border-bottom-right-radius: 2px;
        font-weight: bold;
    }

    .input-area {
        padding: 20px;
        background-color: #1a1a1a;
        border-top: 1px solid #333;
        display: flex;
        gap: 10px;
    }

    .chat-input {
        flex: 1;
        padding: 15px;
        border-radius: 25px;
        border: 1px solid #444;
        background-color: #000;
        color: white;
        outline: none;
    }

    .chat-input:focus {
        border-color: var(--neon-green);
    }

    .send-btn {
        background-color: var(--neon-green);
        color: black;
        border: none;
        padding: 0 25px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
    }
    
    .send-btn:hover {
        opacity: 0.9;
    }
    
    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    .loading {
        color: var(--neon-green);
        font-size: 0.8rem;
        margin-left: 10px;
        display: none;
    }

    @media (max-width: 768px) {
        .chat-container {
            height: 80vh; /* í™”ë©´ ë†’ì´ì˜ 80% */
            margin: 10px;
        }
        
        .message {
            max-width: 90%; /* ë§í’ì„  ë” ë„“ê²Œ */
            font-size: 0.9rem;
        }
    }
</style>

<div class="chat-container">
    <div class="chat-header">ğŸ¬ AI ì˜í™” ì¶”ì²œ ë´‡</div>
    
    <div class="chat-messages" id="chat-box">
        <div class="message bot">
            ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë‹¹ì‹ ì˜ ì˜í™” ì»¬ë ‰ì…˜ì„ í•™ìŠµí•œ AIì…ë‹ˆë‹¤.<br>
            "ì¬ë°ŒëŠ” ì•¡ì…˜ ì˜í™” ì¶”ì²œí•´ì¤˜" ì²˜ëŸ¼ ë¬¼ì–´ë³´ì„¸ìš”!
        </div>
    </div>
    
    <div style="padding:0 20px; margin-bottom:10px;">
        <span class="loading" id="loading-indicator">ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
    </div>

    <div class="input-area">
        <input type="text" class="chat-input" id="user-input" placeholder="ì˜í™”ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMessage()">
        <button class="send-btn" onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>

<script>
    function sendMessage() {
        const inputField = document.getElementById('user-input');
        const message = inputField.value.trim();
        const chatBox = document.getElementById('chat-box');
        const loadingIndicator = document.getElementById('loading-indicator');

        if (message === "") return;

        // 1. ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ì— í‘œì‹œ
        chatBox.innerHTML += `<div class="message user">${message}</div>`;
        inputField.value = "";
        chatBox.scrollTop = chatBox.scrollHeight; // ìŠ¤í¬ë¡¤ ë‚´ë¦¬ê¸°

        // 2. ë¡œë”© í‘œì‹œ
        loadingIndicator.style.display = 'block';

        // 3. ì„œë²„(AJAX) ìš”ì²­
        fetch("{% url 'movies:chatbot' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `message=${encodeURIComponent(message)}`
        })
        .then(response => response.json())
        .then(data => {
            // 4. ë´‡ ì‘ë‹µ í‘œì‹œ
            loadingIndicator.style.display = 'none';
            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬í•´ì„œ ì¶œë ¥
            const botResponse = data.response.replace(/\n/g, '<br>');
            chatBox.innerHTML += `<div class="message bot">${botResponse}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(error => {
            console.error('Error:', error);
            loadingIndicator.style.display = 'none';
            chatBox.innerHTML += `<div class="message bot" style="color:red;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>`;
        });
    }
</script>
{% endblock %}